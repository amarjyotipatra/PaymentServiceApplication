# Payment Service Application

This is a Spring Boot-based microservice designed to handle payment operations, including payment link generation and webhook processing. It is designed to be flexible and support multiple payment gateways.

## Features

*   **Payment Link Generation:**  Generates payment links for easy payment processing.
*   **Payment Gateway Abstraction:**  Uses an interface (`IPaymentGateway`) to abstract the payment gateway logic, allowing easy integration of different payment providers (currently supports Razorpay and Stripe).
* **Stripe webhooks:** Able to receive events from Stripe using webhooks.
*   **RESTful API:** Exposes a RESTful API for payment-related operations.
*   **Spring Boot:** Built using the Spring Boot framework for simplified development and deployment.
*   **Dependency Injection:** Utilizes Spring's dependency injection for loose coupling and testability.
* **Gradle**: Uses Gradle as a build tool.
* **Comprehensive Test Suite**: Includes JUnit tests for all components.

## Prerequisites

*   **Java JDK 21:** Ensure you have Java Development Kit (JDK) version 21 installed.
*   **Payment Gateway Accounts:**
    *   **Razorpay:** A Razorpay account with API keys (ID and secret).
    *   **Stripe:** A Stripe account with API keys.
* **Gradle:** Gradle is included as a wrapper (`gradlew`), but you can use a globally installed version if you prefer.

## Getting Started

1.  **Clone the Repository:**

    ```bash
    git clone <repository-url>
    cd PaymentServiceApplication
    ```

2.  **Configure Application Properties:**

    *   Rename `src/main/resources/application.properties.example` to `src/main/resources/application.properties`.
    *   Open `application.properties` and set the following properties:
        *   `spring.application.name`: Name of the application (e.g., `PaymentServiceApplication`).
        *   `razorpay.id`: Your Razorpay Key ID.
        *   `razorpay.secret`: Your Razorpay Key Secret.
        * `stripe.apiKey`: Your Stripe API key.
        * You can also set local properties here, or using environment variables.

    * **Important:** Do not commit sensitive information directly in the `application.properties` file. Consider using environment variables for sensitive data. Refer to the Security section for more details.
3.  **Build the Project:**

    ```bash
    ./gradlew clean build
    ```

4.  **Run the Application:**

    ```bash
    ./gradlew bootRun
    ```

5.  **Access the Application:** Once running, the application will be accessible at `http://localhost:8080`.

## Running Tests

The application includes a comprehensive test suite that validates all components of the system. To run the tests:

```bash
./gradlew test
```

### Test Coverage

The test suite includes tests for:

* **Service Layer Tests**: Validates the `PaymentService` functionality
* **Controller Tests**: Ensures the REST endpoints work correctly
* **Payment Gateway Tests**: Tests both Razorpay and Stripe payment gateway implementations

To run specific test classes:

```bash
./gradlew test --tests "com.example.paymentserviceapplication.services.PaymentServiceTests"
./gradlew test --tests "com.example.paymentserviceapplication.controllers.PaymentControllerTests"
./gradlew test --tests "com.example.paymentserviceapplication.paymentgateways.RazorpayPaymentGatewayTests"
./gradlew test --tests "com.example.paymentserviceapplication.paymentgateways.StripePaymentGatewayTests"
```

## API Endpoints

### Payment

*   `POST /payment`: Initiate a payment (supports payment link generation using either Razorpay or Stripe, with Stripe as the default).
    *   **Request Body:**

    ```json
    {
      "name": "John Doe",
      "email": "john.doe@example.com",
      "phoneNumber": "1234567890",
      "orderId": "order123",
      "amount": 1000
    }
    ```

    * **Response**: Returns the payment link generated by the active payment gateway.

### Webhooks

*   `POST /stripeWebhook`: Receive events from Stripe.
    *   **Request Body:** A JSON payload representing a Stripe event.

## Application Architecture

### Components

* **Controllers**: Handle HTTP requests and responses
  * `PaymentController`: Processes payment requests
  * `WebhookController`: Handles webhook callbacks from payment providers

* **Services**: Contain business logic
  * `IPaymentService`: Interface defining payment operations
  * `PaymentService`: Implementation of payment operations

* **Payment Gateways**: Integrate with external payment providers
  * `IPaymentGateway`: Interface for payment gateway abstraction
  * `RazorpayPaymentGateway`: Implementation for Razorpay
  * `StripePaymentGateway`: Implementation for Stripe (marked as `@Primary`)

* **DTOs**: Data Transfer Objects
  * `PaymentDTO`: Represents payment request data

* **Configuration**: Spring configuration classes
  * `RazorpayConfig`: Configuration for Razorpay

### Flow

1. Client sends a payment request to `/payment` endpoint
2. `PaymentController` receives the request and passes data to `PaymentService`
3. `PaymentService` delegates to the active `IPaymentGateway` implementation
4. The payment gateway generates a payment link and returns it
5. The payment link is returned to the client

## Security

*   **Sensitive Data:** Never commit sensitive data (like API keys) directly to your repository. Use environment variables or other secure configuration methods.
*   **Environment Variables (Recommended):** You can use environment variables to set the following properties:
    *   `razorpay.id`: Your Razorpay Key ID.
    *   `razorpay.secret`: Your Razorpay Key Secret.
    * `stripe.apiKey`: Your Stripe API key.
* **Local configuration**: You can also create a local configuration file, and not commit it to your repository.
* **application.properties.example**: This file contains examples of properties that can be set.

## Payment Gateway Integration

*   **`IPaymentGateway`:** This interface defines the contract for interacting with different payment gateways.
*   **Extensibility:** You can add new payment gateways by implementing the `IPaymentGateway` interface and configuring the dependency injection in your Spring Boot application.
*   **Default Gateway:** Stripe is configured as the default gateway with the `@Primary` annotation.

## Webhooks

*   **Stripe Webhooks:** The `WebhookController` handles incoming events from Stripe.
*   **Security**: Make sure to secure your webhook endpoint using Stripe's webhook signatures.

## Troubleshooting

### Common Issues

1. **API Key Issues**: Ensure your Razorpay and Stripe API keys are correctly configured.
   
2. **Test Failures**: If tests are failing, check:
   - Mocking configurations in the test classes
   - Exception handling in the tests
   - Field accessibility for mocked objects

3. **Webhook Problems**: Verify that your webhook endpoint is accessible from the internet if testing with real providers.

### Debugging

Enable debug logging by adding the following to your `application.properties`:

```
logging.level.com.example.paymentserviceapplication=DEBUG
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add or update tests as needed
5. Submit a pull request

## License

[Add your license information here]
